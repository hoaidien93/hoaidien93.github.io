define(["API/Search","API/Address","API/Post","API/UserAPI"],()=>({viewModel:function(){const searchAPI=require("API/Search"),addressAPI=require("API/Address"),postAPI=require("API/Post"),store=require("Store/Store"),userAPI=require("API/UserAPI");let dataChangePage=this._request.data,searchInput=this._request.searchInput||"";this.listPinID=ko.observableArray([]),this.temp=new Array(10).fill(1),this.resultSearch=ko.observableArray([]),this.listDistrict=ko.observableArray([]),this.listWards=ko.observableArray([]),this.selectedArea=ko.observable(0),this.selectedPrice=ko.observable(0),this.selectedDistrict=ko.observable({}),this.selectedWard=ko.observable({});let isSetFilter=!1;this.order=ko.observable(1),this.isShowEmpty=ko.observable(!1);let me=this;this.converterPrice=ko.pureComputed(()=>{let res={max_price:0,min_price:0};switch(this.selectedPrice()){case"1":res.max_price=1e6,res.min_price=0;break;case"2":res.max_price=2e6,res.min_price=1e6;break;case"3":res.max_price=2e6,res.min_price=5e6;break;case"4":res.max_price=1e8,res.min_price=5e6}return res}),this.converterArea=ko.pureComputed(()=>{let res={max_area:0,min_area:0};switch(this.selectedArea()){case"1":res.max_area=20,res.min_area=0;break;case"2":res.max_area=40,res.min_area=20;break;case"3":res.max_area=5e3,res.min_area=40}return res}),this.resultSearch.subscribe(function(newValue){0===newValue.length?me.isShowEmpty(!0):me.isShowEmpty(!1)});let page=0,size=2;addressAPI.getDistricts().then(res=>{let listDiscict=[{id:0,name:"Quận"}].concat(res.data);this.listDistrict(listDiscict)}).catch(e=>{console.log(e)}),this.selectedDistrict.subscribe(e=>{e?addressAPI.getWards(e).then(res=>{let listWards=[{id:0,name:"Phường"}].concat(res.data);this.listWards(listWards)}).catch(e=>{console.log(e)}):this.listWards([{id:0,name:"Phường"}])});var user_id;this.afterBinding=(()=>{$("#search").val(searchInput),cordova.plugins.firebase.messaging.onMessage(function(payload){setTimeout(()=>{app.setPage("PostDetail",{id:payload.post_id})},1e3)}),cordova.plugins.firebase.messaging.onBackgroundMessage(function(payload){setTimeout(()=>{app.setPage("PostDetail",{id:payload.post_id})},1e3)}),$(window).off("scroll"),$(window).on("scroll",function(){$(".app").height()<=$("html").scrollTop()+$(window).height()+1&&page<size&&(isSetFilter?callFilter():getStartPage())}),userAPI.getInfo().then(res=>{localStorage.setItem("imageURL",res.data.avatar),localStorage.setItem("name",res.data.display_name),localStorage.setItem("email",res.data.email||""),localStorage.setItem("userId",res.data.user_id),localStorage.setItem("created_at",res.data.created_at),localStorage.setItem("phone",res.data.phone||""),localStorage.setItem("address",res.data.address||"Hồ Chí Minh"),$("com-slider img")[0].src=res.data.avatar,$("com-slider .information-user p")[0].innerHTML=window.localStorage.getItem("name"),user_id=res.data.user_id,cordova.plugins.firebase.messaging.requestPermission({forceShow:!0}).then(function(){cordova.plugins.firebase.messaging.subscribe(`/topics/notification.user.${user_id}`).then(e=>{console.log(e)}).catch(e=>{console.log(e)})}).catch(e=>{})}).catch(e=>{console.log(e)})});let getStartPage=()=>{store.isShowLoading(!0),searchAPI.indexPage(page++).then(res=>{size=Math.ceil(res.data.total/10),this.resultSearch.push(...res.data.hits.map(e=>Object.assign(e,{pinned:ko.observable(!1)}))),store.isShowLoading(!1)}).catch(e=>{console.log(e),store.isShowLoading(!1)})};this.resultWithPin=ko.pureComputed(()=>{let result=this.resultSearch();return result.forEach(e=>{this.listPinID.indexOf(e.id)>-1?e.pinned(!0):e.pinned(!1)}),result}),dataChangePage?this.resultSearch(dataChangePage.map(e=>Object.assign(e,{pinned:ko.observable(!1)}))):getStartPage(),$(document).off("changeSearchResult"),$(document).on("changeSearchResult",(event,res)=>{this.resultSearch(res.data.map(e=>Object.assign(e,{pinned:ko.observable(!1)})))}),this.addFavorite=((data,event)=>{}),postAPI.getMyPin().then(res=>{me.listPinID(res.data.hits.map(e=>e.id))}).catch(e=>{console.log(e)}),this.applyFilter=(()=>{isSetFilter=!0,page=0,this.resultSearch([]),callFilter()});let callFilter=()=>{store.isShowLoading(!0),searchAPI.filter({max_area:this.converterArea().max_area,min_area:this.converterArea().min_area,district_id:this.selectedDistrict(),max_price:this.converterPrice().max_price,min_price:this.converterPrice().min_price,ward_id:this.selectedWard(),location:document.getElementById("search").value,order:this.order()},page++).then(res=>{store.isShowLoading(!1),size=Math.ceil(res.data.total/10),this.resultSearch.push(...res.data.hits.map(e=>Object.assign(e,{pinned:ko.observable(!1)})))}).catch(e=>{console.log(e)})};this.removePopupSuccess=(()=>{store.isShowBlank(!1),$("#popup-success").removeClass("active"),this.order($("input[name='order']:checked").val())}),this.getOrder=(()=>{$(`input[value='${this.order()}']`)[0].checked=!0,$("#popup-success").addClass("active"),store.isShowBlank(!0)}),this.changePageDetail=((data,event)=>{app.setPage("PostDetail",Object.assign(data,{location:$("#search").val()}))})},template:'\n            <div id="home-page">\n    <com-slider></com-slider>\n    <com-headercontext></com-headercontext>\n    <div class="popup success" id="popup-success">\n        <div class="title">Tiêu chí sắp xếp</div>\n        <div class="order-field">\n            <input type="radio" name="order" value="1" id="input1">\n            <label for="input1">Mới nhất</label>\n        </div>\n        <div class="order-field">\n            <input type="radio" name="order" value="0" id="input0">\n            <label for="input0">Cũ nhất</label>\n        </div>\n        <div class="order-field">\n            <input type="radio" name="order" value="2" id="input2">\n            <label for="input2">Giá thấp</label>\n        </div>\n        <div class="order-field">\n            <input type="radio" name="order" value="3" id="input3">\n            <label for="input3">Giá cao</label>\n        </div>\n        <div class="order-field">\n            <input type="radio" name="order" value="4" id="input4">\n            <label for="input4">Diện tích tăng dần</label>\n        </div>\n        <div class="order-field">\n            <input type="radio" name="order" value="5" id="input5">\n            <label for="input5">Diện tích giảm dần</label>\n        </div>\n        <button class="btn-submit" style="padding: 7px 22px;margin-top: 10px;"\n            data-bind="event: {tap: removePopupSuccess}">OK</button>\n    </div>\n    <div class="body-content">\n        <div class="filter">\n            <select name="district_id" data-bind="\n                options: listDistrict,\n                optionsText: function(item){return item.name},\n                optionsValue: function(item){return item.id},\n                value: selectedDistrict">\n            </select>\n            <select name="ward_id" data-bind="\n                options: listWards,\n                optionsText: function(item){return item.name},\n                optionsValue: function(item){return item.id},\n                value: selectedWard">\n            </select>\n            <div class="dp-flex">\n                <select name="price-range" data-bind="value: selectedPrice">\n                    <option value="0" selected>Khoảng giá</option>\n                    <option value="1">Dưới 1.000.000</option>\n                    <option value="2">1.000.000 - 2.000.000</option>\n                    <option value="3">2.000.000 - 5.000.000</option>\n                    <option value="4">Trên 5.000.000</option>\n                </select>\n                <select name="area" data-bind="value: selectedArea">\n                    <option value="" selected>Diện tích</option>\n                    <option value="1">Dưới 20m²</option>\n                    <option value="2">Từ 20m² đến 40m²</option>\n                    <option value="3">Trên 40m²</option>\n                </select>\n            </div>\n            <div class="apply-filter">\n                <button data-bind="event: {tap: getOrder}">Sắp xếp</button>\n                <button data-bind="event: {tap: applyFilter}">Áp dụng</button>\n            </div>\n        </div>\n        <div class="empty-content" data-bind="visible: isShowEmpty">Không tìm thấy bài đăng phù hợp</div>\n\n        <div class="search-result" data-bind="foreach: resultWithPin">\n            <div class="search-item" data-bind="event: {tap: $root.changePageDetail}">\n                <div class="image-wrapper">\n                    <img data-bind="attr: {src: image ? image: \'./img/example.jpg\'}">\n                </div>\n                <div class="content-wrapper">\n                    <div class="content-title" data-bind="html: title"></div>\n                    <div class="content-bottom">\n                        <div class="content-price">\n                            <div class="price" data-bind="convertMoney: price"></div>\n                        </div>\n                        <div class="content-description">\n                            <span data-bind="convertTime: created_at"></span>\n                            <span data-bind="html: location" class="location"></span>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n        '}));